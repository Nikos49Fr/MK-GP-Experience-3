// /sass/classement.scss
// ----------------------------------------------------
// Classement Widget (250x800) — MK GP Experience 3
// ----------------------------------------------------
@use 'variables' as *; // import globales (couleurs, polices, etc.)
@use 'fonts';          // import des polices locales
@use 'sass:math';
@use 'sass:map';

// ----------------------
// Variables locales polices (famille + poids + taille)
// ----------------------
$font-rank: $font-f1;
$font-rank-weight: $font-weight-f1bold;
$font-rank-size: 14px;

$font-tag: $font-f1;
$font-tag-weight: 700;
$font-tag-size: 14px;

$font-points: $font-f1;
$font-points-weight: 400;
$font-points-size: 12px;
$font-points-color: #aaa;

// -------- Polices pour la colonne combinée (identité) --------
$font-ident-tag-family:   $font-f1;
$font-ident-tag-weight:   700;
$font-ident-tag-size:     14px;

$font-ident-pilot-family: $font-f1;   // libre à toi de mettre $font-f1
$font-ident-pilot-weight: 400;
$font-ident-pilot-size:   13px;

// ----------------------
// Variables globales
// ----------------------
$opacity-rank: 0.95;
$opacity-state: 0.9;
$opacity-secondary: 0.85;
$opacity-header: 1;

$w-widget: 250px;
$h-widget: 800px;

$h-header: 60px;
$h-state: 26px;
$pad-state-y: 4px;

$border-state-color: rgba(255, 255, 255, 0.25);

$row-h: math.div(($h-widget - $h-header - $h-state), 24); // hauteur fixe d’une ligne

// ----------------------
// Variables couleurs de fond (tes valeurs de test)
// ----------------------
$bg-header: $bg-color; // header
$bg-state: #333;      // state
$bg-rank: $bg-color;   // rank
$bg-other: #222;       // team/tag/bonus/points

// ----------------------
// Helpers
// ----------------------
@mixin text-ellipsis {
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
}

// ----------------------------------------------------
// Presets d’affichage (SCSS map) + classes modifieurs
// ----------------------------------------------------
$classement-presets: (
    'mk8-12': (rows: 12),
    'mkw-24': (rows: 24),
    'teams-6': (rows: 6),
    'teams-8': (rows: 8),
    'msg-prestart': (rows: 0),
    'msg-mk8-noscores': (rows: 0),
    'msg-mkw-noscores': (rows: 0)
);

@each $key, $conf in $classement-presets {
    .classement-widget--#{$key} {
        @if map.get($conf, rows) > 0 {
            .cw-list {
                // on N'IMPOSE PAS de template-rows ici
                // la hauteur vient du nb d’enfants + grid-auto-rows
                display: grid;
                grid-auto-rows: $row-h;
                padding: 0; margin: 0; gap: 0; border: 0; border-radius: 0; box-shadow: none;
            }
        // --- MODES MESSAGE (rows = 0) ---
        }
        @else {
            .cw-list {
                // conteneur centre + padding autorisé pour les messages
                display: flex;
                align-items: center;
                justify-content: center;

                // on garde le fond défini globalement (bg-other + $opacity-secondary)
                padding: 50px 12px; // padding autorisé UNIQUEMENT pour les presets message
                margin: 0;
                gap: 0;
                border: 0;
                border-radius: 0;
                box-shadow: none;

                .cw-message {
                    // largeur max pour aérer un peu le texte
                    max-width: 220px;
                    text-align: center;

                    // Vertical rhythm global
                    line-height: 2;

                    // Reset marges par défaut
                    h2, h3, p, span { margin: 0; padding: 0; }

                    // TITRE principal (Formula1)
                    h2 {
                        font-family: $font-f1;      // Formula1
                        font-weight: 700;           // gras fourni par @font-face
                        font-size: 24px;
                        letter-spacing: 0.5px;
                        text-transform: uppercase;
                        line-height: 1.1;

                        // petite respiration sous le titre
                        margin-bottom: 6px;
                    }

                    // Le premier <span> après h2 (le “3”) — style badge
                    // (fonctionne avec ton HTML actuel : <h2>...</h2><span>3</span>)
                    h2 + span {
                        display: inline-block;
                        font-family: $font-f1;
                        font-weight: 700;
                        font-size: 24px;
                        line-height: 1;
                        padding: 4px 10px;
                        border-radius: 999px;
                        background: rgba(255,255,255,0.12);
                        color: $text-color;
                        margin-bottom: 10px;
                    }

                    // Sous-titres (Formula1)
                    h3 {
                        font-family: $font-f1;      // Formula1
                        font-weight: 700;
                        font-size: 20px;
                        letter-spacing: 0.4px;
                        text-transform: uppercase;
                        margin-top: 10px;
                        margin-bottom: 4px;
                    }

                    // Lignes d’info (spans/p) — un poil plus grandes et lisibles
                    p, span {
                        display: block;
                        font-family: $font-points;   // tu peux switcher vers $font-f1 si tu préfères
                        font-weight: $font-points-weight;
                        font-size: 16px;            // un peu plus grand
                        letter-spacing: 0.2px;
                        opacity: 0.95;
                    }
                    p {
                        padding-top: 10px;
                        border-top: 1px solid #999;
                    }

                    // Micro-espacement entre les lignes
                    p + p, p + span, span + p, span + span {
                        margin-top: 3px;
                    }

                    // Un léger séparateur visuel entre blocs
                    h3 + span { margin-top: 4px; }
                }
            }
        }
    }
}


// ----------------------
// Racine du composant
// ----------------------
.classement-widget {
    box-sizing: border-box;
    width: $w-widget;
    height: auto; // ← au lieu de height: $h-widget
    background: transparent;
    color: $text-color;
    overflow: hidden;
    display: flex;
    flex-direction: column;

    padding: 0;
    margin: 0;
    gap: 0;
    border: none;
    box-shadow: none;

    border-top-left-radius: 16px;
    border-top-right-radius: 16px;
    // margin pour test
    // margin-left: 120px;
}

// ----------------------
// Header (logo)
// ----------------------
.cw-header {
    box-sizing: border-box;
    height: $h-header;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba($bg-header, $opacity-header);

    img {
        display: block;
        max-height: 100%;
        max-width: 100%;
        height: auto;
    }
}

// ----------------------
// État de la course
// ----------------------
.race-state {
    box-sizing: border-box;
    height: $h-state;
    display: flex;
    align-items: center;
    justify-content: center;

    background: rgba($bg-state, $opacity-state);

    border-top: 1px solid $border-state-color;
    border-bottom: 1px solid $border-state-color;
    padding-top: $pad-state-y;
    padding-bottom: $pad-state-y;

    font-family: $font-tag;
    font-weight: $font-tag-weight;
    font-size: $font-tag-size;
    letter-spacing: 0.5px;
}

// ----------------------
// Liste du classement
// ----------------------
.cw-list {
    box-sizing: border-box;
    //height: calc(#{$h-widget} - #{$h-header} - #{$h-state}); // hauteur fixe désactivée
    display: grid;
    grid-auto-rows: $row-h; // ← chaque ligne a la même hauteur qu’en mode 24
    // grid-template-rows: repeat(24, 1fr);
    background: rgba($bg-other, $opacity-secondary);
}

// ----------------------
// Ligne de classement
// ----------------------
.cw-row {
    display: grid;
    // rank | team | tag | bonus | points
    grid-template-columns: 36px 30px 1fr 30px 60px;
    align-items: stretch; // étire toutes les colonnes sur la hauteur
    height: 100%;
    min-height: 0;
    overflow: hidden;

    // Ancrage explicite des colonnes : évite le décalage quand .col-bonus est absente
    > .col-rank   { grid-column: 1; }
    > .col-team   { grid-column: 2; }
    > .col-tag    { grid-column: 3; }
    > .col-bonus  { grid-column: 4; } // peut ne pas exister → la colonne reste réservée
    > .col-points { grid-column: 5; } // ne bouge plus

    // Colonne Rank (fond propre)
    .col-rank {
        background: rgba($bg-rank, $opacity-rank);
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;

        font-family: $font-rank;
        font-weight: $font-rank-weight;
        font-size: $font-rank-size;
        line-height: 1;
        letter-spacing: 0.2px;
        padding: 0;

        // On s'assure que le contenu peut aligner l'icône + le chiffre proprement
        display: inline-flex;
        align-items: center;
        gap: 4px;

        .rank-delta {
            // Triangle via border
            display: inline-block;
            width: 0;
            height: 0;

            // Taille et couleurs (ajustables si besoin)
            $delta-size: 6px;
            $delta-green: #2ecc71; // vert
            $delta-red:   #e74c3c; // rouge

            // ↑ triangle plein vert
            &.up {
                border-left:  $delta-size solid transparent;
                border-right: $delta-size solid transparent;
                border-bottom:$delta-size solid $delta-green;
                transform: translateY(-1px); // petit ajustement vertical
            }

            // ↓ triangle plein rouge
            &.down {
                border-left:  $delta-size solid transparent;
                border-right: $delta-size solid transparent;
                border-top:   $delta-size solid $delta-red;
                transform: translateY(1px); // petit ajustement vertical
            }
        }
    }

    // --- Colonne TEAM (logo équipe OU photo pilote selon phase) ---
    .col-team {
        background: transparent;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;

        .team-logo {
            width: 24px;   // logo équipe
            height: 24px;
            object-fit: contain;
            display: block;
        }

        &.is-pilot .team-logo {
            width: 28px;   // photo pilote
            height: 28px;
            object-fit: cover;
            border-radius: 3px; // optionnel
        }
    }

    // --- Colonne TAG (TAG fixe ↔ num + nom défilant) ---
    .col-tag {
        background: transparent; // l’opacité vient de .cw-list
        height: 100%;
        display: flex;
        align-items: center;
        padding: 0 2px;
        min-width: 0;      // indispensable pour ne pas pousser .col-points
        overflow: hidden;  // jamais de scrollbar ni débordement

        // Vue TAG (texte simple, ellipsis CSS)
        font-family: $font-tag;
        font-weight: $font-tag-weight;
        font-size: $font-tag-size;
        letter-spacing: 0.6px;
        @include text-ellipsis;
        
        // Vue TAG uniquement (quand pas en mode pilot)
        &:not(.mode-pilot) {
            padding-left: 8px; // ← ajuste la valeur comme tu veux
        }

        // Vue PILOT (activée par JS via .mode-pilot)
        &.mode-pilot {
            // scroller horizontal injecté par le JS
            .tagcard-scroller {
                display: inline-flex;
                align-items: center;
                gap: 6px;
                will-change: transform;
                min-width: 0;
                max-width: 100%;
                overflow: hidden;
                background: transparent;
            }

            .tagcard-num {
                font-family: $font-ident-pilot-family;
                font-weight: max(600, $font-ident-pilot-weight);
                font-size: $font-ident-pilot-size;
            }

            .tagcard-name {
                font-family: $font-ident-pilot-family;
                font-weight: $font-ident-pilot-weight;
                font-size: $font-ident-pilot-size;
                white-space: nowrap; // le défilement est géré en JS
            }
        }
    }

    // --- Colonnes BONUS + POINTS (inchangées) ---
    .col-bonus,
    .col-points {
        background: transparent; // l’opacité vient de .cw-list
        height: 100%;
        display: flex;
        align-items: center;
    }

    .col-bonus {
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;

        /* largeur fixe pour éviter les sauts lors des updates */
        min-width: 36px;
        width: 36px;
        flex: 0 0 36px; /* si la ligne est en flex */
        padding-inline: 4px;
    }

    /* Icône bonus : taille/centrage, hover désactivé */
    .bonus-icon {
        display: inline-block;
        vertical-align: middle;
        width: 16px;
        height: 16px;

        pointer-events: none;     /* pas d’interaction */
        user-select: none;
        -webkit-user-drag: none;

        background-repeat: no-repeat;
        background-position: center;
        background-size: contain;
    }

    .bonus--used        { background-image: url("../assets/icons/bonus-used.png"); opacity: 0.5;}
    .bonus--armed       { background-image: url("../assets/icons/bonus-armed.png"); width: 20px; height: 20px;}
    .bonus--unavailable { background-image: url("../assets/icons/bonus-locked.png"); }
    .bonus--available   { background-image: url("../assets/icons/bonus-available.png"); }

    @media (max-width: 1200px) {
        .bonus-icon { width: 18px; height: 18px; }
    }
    @media (max-width: 800px) {
        .bonus-icon { width: 16px; height: 16px; }
    }
    
    .col-points {
        padding: 0 6px;
        justify-content: flex-end;
        font-family: $font-points;
        font-weight: $font-points-weight;
        font-size: $font-points-size;
        color: $font-points-color;
        letter-spacing: 0.4px;
        @include text-ellipsis;
    }

    // --- Lignes vides ---
    &.is-empty {
        .col-tag,
        .col-points,
        .col-bonus {
            opacity: 0.35;
        }

        .col-team .team-logo {
            opacity: 0.3;
            filter: grayscale(100%);
        }
    }
}
/* ============================================================
   Mode ÉQUIPE : supprimer visuellement la colonne Bonus
   - La grille reste sur 5 colonnes (points reste en 5)
   - .col-tag occupe 3 + 4 → récupère la largeur de "bonus"
   ============================================================ */
.classement-widget.is-team .cw-row {
    /* 1) Bonus compressé à 0 → pas de décalage de col-points */
    grid-template-columns: 36px 30px 1fr 0 60px;
}

.classement-widget.is-team .cw-row > .col-tag {
    /* 2) Tag s’étend sur les colonnes 3 et 4 (prend la place de bonus) */
    grid-column: 3 / 5;
}

/* (sécurité) si .col-bonus existe encore dans le DOM, on le cache */
.classement-widget.is-team .cw-row > .col-bonus {
    display: none !important;
}

/* (rappel) points reste bien en 5 */
.classement-widget.is-team .cw-row > .col-points {
    grid-column: 5;
}
